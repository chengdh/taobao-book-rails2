<script type='text/javascript'>
  //缓存在客户端的豆瓣书籍hash isbn13 -> douban_book
var douban_books = new Hash();
//监听单本书籍价格及数量的变化
//type price 或 num
var book_price_num_listener = function(evt,isbn13,type) {
  var el = Event.element(evt);
  book = douban_books.get(isbn13);
  if(type == 'price')
    book.price = el.value;
  else
    book.num = el.value;
};

</script>
<div class="block">
  <div class="secondary-navigation">
    <ul class="wat-cf">
      <li class="first"><%= link_to "查书", search_douban_taobao_books_path %></li>
      <li class="active"><%= link_to "查询结果", "" %></li>
    </ul>
  </div>          
  <div class="content">          
    <h2 class="title">来自豆瓣的书籍列表</h2>
    <div class="inner">
      <div class="actions-bar border-bottom" id='selector_wrap'>
        <div id='selector'>
          <%= link_to_function "全选","selector.select_all(true)" %>
          &nbsp;|&nbsp;
          <%= link_to_function "不选","selector.select_all(false)"  %>
        </div>
        <span id='select_des'>选定书籍,可以批量上传到淘宝...</span>
        <div id='btn_wrap'>
          <%=link_to_function "上传到淘宝","upload_item()",:class => 'sexybutton sexysimple sexybig sexyblue'%>
        </div>
      </div>
      <div class='actions-bar border-bottom'>
        <label>选择更新项目:</label>
        <%= check_box_tag "title","title",true %><%=label_tag "title","书名" %>
        <%= check_box_tag "isbn13","isbn13",true %><%=label_tag  "isbn13","ISBN" %>
        <%= check_box_tag  "author","author",true  %><%=label_tag "author","作者" %>
        <%= check_box_tag  "image","image",true  %><%=label_tag  "image","封面图片" %>
        <%= check_box_tag  "publisher","publisher",true  %><%=label_tag  "publisher","出版社" %>
        <%= check_box_tag  "pubdate","pubdate",true  %><%=label_tag  "pubdate","出版日期" %>
        <%= check_box_tag  "pages","pages",true  %><%=label_tag  "pages","页数" %>
        <%= check_box_tag  "price","price",true  %><%=label_tag  "price","定价" %>
        <%= check_box_tag  "binding","binding",true  %><%=label_tag  "binding","装帧" %>
        <%= check_box_tag  "summary","summary",true  %><%=label_tag  "summary","书籍介绍" %>
        <%= check_box_tag  "author_intro","author_intro",true  %><%=label_tag "author_intro","作者介绍" %>
      </div>

      <table class="table" id='items_list'>
        <% @douban_books.each do |douban_book| %>
          <script type='text/javascript'>
            var book = <%=douban_book.to_json %>
          book.num = 100
          douban_books.set('<%=douban_book.isbn13%>',book)
          </script>
          <%= render "douban_book",:douban_book => douban_book %>
        <% end%>
      </table>
      <div class="actions-bar wat-cf">
        <div class="actions">
        </div>
      </div>
    </div>
  </div>
</div>
<% content_for :sidebar, render(:partial => 'sidebar') -%>
<script type='text/javascript'>
  selector = new com.strongu.Selector(<%= @douban_book_isbns.to_json %>,'select_des');
  selector.add_check_listener('items_list');
  //获取用户选择的要更新的属性
  var get_update_attrs = function() {
    var els = $$("#title,#isbn13,#author,#image,#publisher,#pubdate,#pages,#price,#binding,#summary,#author_intro");
    var select_els = els.findAll(function(el){ return el.checked;})
    var update_attrs = select_els.collect(function(el) {return el.value;});
    return {"select_attrs[]" : update_attrs};
  };
  //批量上传到taobao
  var upload_item = function(){
    //设置需要更新的属性列表,默认更新全部
    selector.selected_ids().each(function(isbn13){
        var the_douban_book = douban_books.get(isbn13);
        //发起ajax请求
        new Ajax.Request('<%=upload_item_taobao_books_path%>', 
            {
              method : 'post',
              asynchronous:true, 
              evalScripts:true, 
              onCreate : function() {$('ajax_' + isbn13).show();},
              onComplete : function() {$('ajax_' + isbn13).hide();},
              parameters:Form.serialize($('upload_taobao_book_form')) + 
              "&" + Object.toQueryString(com.strongu.util.object_to_hash(the_douban_book,"douban_book")) + 
              "&" + Object.toQueryString(get_update_attrs())
}); 
        },window);
  };

</script>
